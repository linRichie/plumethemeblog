import{_ as e,c as t,a,b as h,d as n,w as p,r as c,o as k,e as l}from"./app-BVpc6fz1.js";const d={},r={class:"table-of-contents"};function g(o,s){const i=c("router-link");return k(),t("div",null,[a("nav",r,[a("ul",null,[a("li",null,[n(i,{to:"#简介"},{default:p(()=>s[0]||(s[0]=[l("简介")])),_:1})]),a("li",null,[n(i,{to:"#_1-传统构建方式的问题"},{default:p(()=>s[1]||(s[1]=[l("1. 传统构建方式的问题")])),_:1}),a("ul",null,[a("li",null,[n(i,{to:"#_1-1-单一-dockerfile-方式"},{default:p(()=>s[2]||(s[2]=[l("1.1 单一 Dockerfile 方式")])),_:1})]),a("li",null,[n(i,{to:"#_1-2-多-dockerfile-方式"},{default:p(()=>s[3]||(s[3]=[l("1.2 多 Dockerfile 方式")])),_:1})])])]),a("li",null,[n(i,{to:"#_2-多阶段构建"},{default:p(()=>s[4]||(s[4]=[l("2. 多阶段构建")])),_:1}),a("ul",null,[a("li",null,[n(i,{to:"#_2-1-基本用法"},{default:p(()=>s[5]||(s[5]=[l("2.1 基本用法")])),_:1})]),a("li",null,[n(i,{to:"#_2-2-构建镜像"},{default:p(()=>s[6]||(s[6]=[l("2.2 构建镜像")])),_:1})]),a("li",null,[n(i,{to:"#_2-3-高级特性"},{default:p(()=>s[7]||(s[7]=[l("2.3 高级特性")])),_:1})])])]),a("li",null,[n(i,{to:"#_3-最佳实践"},{default:p(()=>s[8]||(s[8]=[l("3. 最佳实践")])),_:1})])])]),s[9]||(s[9]=h(`<hr><h2 id="简介" tabindex="-1"><a class="header-anchor" href="#简介"><span>简介</span></a></h2><p>多阶段构建(Multi-stage builds)是 Docker 17.05 引入的新特性，它允许在一个 Dockerfile 中使用多个 FROM 语句。这种方式可以:</p><ul><li>大幅减少最终镜像的体积</li><li>避免在构建过程中引入不必要的依赖</li><li>简化构建流程</li></ul><h2 id="_1-传统构建方式的问题" tabindex="-1"><a class="header-anchor" href="#_1-传统构建方式的问题"><span>1. 传统构建方式的问题</span></a></h2><p>在多阶段构建出现之前，通常采用两种方式构建镜像：</p><ul><li>全部放入一个 Dockerfile</li><li>分散到多个 Dockerfile</li></ul><h3 id="_1-1-单一-dockerfile-方式" tabindex="-1"><a class="header-anchor" href="#_1-1-单一-dockerfile-方式"><span>1.1 单一 Dockerfile 方式</span></a></h3><p><strong>存在的问题：</strong></p><ul><li>镜像层次多，镜像体积较大，部署时间变长</li><li>源代码存在泄露的风险</li></ul><h4 id="示例-构建-go-应用" tabindex="-1"><a class="header-anchor" href="#示例-构建-go-应用"><span>示例：构建 Go 应用</span></a></h4><ol><li><p>创建 app.go 文件：</p><div class="language-go line-numbers-mode" data-ext="go" data-title="go"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">package</span><span class="space"> </span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">main</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">import</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">fmt</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">func</span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">main</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(){</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">fmt</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Printf</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Hello</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">World!</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>编写 Dockerfile.one：</p><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">FROM</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">golang:1.9-alpine</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">RUN</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">apk</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--no-cache</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">add</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">git</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ca-certificates</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">WORKDIR</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/go/src/github.com/go/helloworld</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">COPY</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">app.go</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">RUN</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">go</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">get</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">-d</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">-v</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">github.com/go-sql-driver/mysql</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">\\</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&amp;</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">&amp;</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">CGO_ENABLED=0</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">GOOS=linux</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">go</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">build</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">-a</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">-installsuffix</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">cgo</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">-o</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">app</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">\\</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&amp;</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">&amp;</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">cp</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/go/src/github.com/go/helloworld/app</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/root</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">WORKDIR</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/root/</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">CMD</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[&quot;./app&quot;]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>构建镜像：</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">build</span><span class="space"> </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">-t</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">go/helloword:1</span><span class="space"> </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">-f</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Dockerfile.one</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ol><h3 id="_1-2-多-dockerfile-方式" tabindex="-1"><a class="header-anchor" href="#_1-2-多-dockerfile-方式"><span>1.2 多 Dockerfile 方式</span></a></h3><p><strong>基本思路：</strong></p><ul><li>第一个 Dockerfile 用于编译构建</li><li>第二个 Dockerfile 用于生成运行环境</li><li>使用脚本将两个阶段连接起来</li></ul><p><strong>示例：</strong></p><ol><li><p>编写 Dockerfile.build（构建阶段）：</p><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">FROM</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">golang:1.9-alpine</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">RUN</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">apk</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--no-cache</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">add</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">git</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">WORKDIR</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/go/src/github.com/go/helloworld</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">COPY</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">app.go</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">RUN</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">go</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">get</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">-d</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">-v</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">github.com/go-sql-driver/mysql</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">\\</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&amp;</span><span style="--shiki-light:#2E8F82;--shiki-dark:#5DA994;">&amp;</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">CGO_ENABLED=0</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">GOOS=linux</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">go</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">build</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">-a</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">-installsuffix</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">cgo</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">-o</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">app</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>编写 Dockerfile.copy（运行阶段）：</p><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">FROM</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">alpine:latest</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">RUN</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">apk</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--no-cache</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">add</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ca-certificates</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">WORKDIR</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/root/</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">COPY</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">app</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">CMD</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[&quot;./app&quot;]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>创建构建脚本 build.sh：</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#!/bin/sh</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">echo</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Building</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">go/helloworld:build</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">build</span><span class="space"> </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">-t</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">go/helloworld:build</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.</span><span class="space"> </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">-f</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Dockerfile.build</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">create</span><span class="space"> </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">--name</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">extract</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">go/helloworld:build</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">cp</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">extract:/go/src/github.com/go/helloworld/app</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">./app</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">rm</span><span class="space"> </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">-f</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">extract</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">echo</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Building</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">go/helloworld:2</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">build</span><span class="space"> </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">--no-cache</span><span class="space"> </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">-t</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">go/helloworld:2</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.</span><span class="space"> </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">-f</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Dockerfile.copy</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">rm</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">./app</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>执行构建：</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">chmod</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">+x</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">build.sh</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">./build.sh</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><p><strong>镜像大小对比：</strong></p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">docker</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">image</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ls</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">REPOSITORY</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">TAG</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">IMAGE</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ID</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">CREATED</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">SIZE</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">go/helloworld</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">2</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">f7cf3465432c</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">22</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">seconds</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ago</span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">6.47MB</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">go/helloworld</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">f55d3e16affc</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">2</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">minutes</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ago</span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">295MB</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><strong>注意：</strong> 虽然第二种方式可以得到更小的镜像，但构建过程较为复杂。</p></blockquote><h2 id="_2-多阶段构建" tabindex="-1"><a class="header-anchor" href="#_2-多阶段构建"><span>2. 多阶段构建</span></a></h2><h3 id="_2-1-基本用法" tabindex="-1"><a class="header-anchor" href="#_2-1-基本用法"><span>2.1 基本用法</span></a></h3><p>使用多阶段构建，只需要一个 Dockerfile 就可以实现上述功能：</p><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">FROM</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">golang:1.9-alpine</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">as</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">builder</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">RUN</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">apk</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--no-cache</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">add</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">git</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">WORKDIR</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/go/src/github.com/go/helloworld/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">RUN</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">go</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">get</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">-d</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">-v</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">github.com/go-sql-driver/mysql</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">COPY</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">app.go</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">RUN</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">CGO_ENABLED=0</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">GOOS=linux</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">go</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">build</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">-a</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">-installsuffix</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">cgo</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">-o</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">app</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">FROM</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">alpine:latest</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">as</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">prod</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">RUN</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">apk</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--no-cache</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">add</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ca-certificates</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">WORKDIR</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/root/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">COPY</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--from=0</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/go/src/github.com/go/helloworld/app</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">CMD</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[&quot;./app&quot;]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-构建镜像" tabindex="-1"><a class="header-anchor" href="#_2-2-构建镜像"><span>2.2 构建镜像</span></a></h3><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">build</span><span class="space"> </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">-t</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">go/helloworld:3</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="_2-3-高级特性" tabindex="-1"><a class="header-anchor" href="#_2-3-高级特性"><span>2.3 高级特性</span></a></h3><h4 id="构建特定阶段" tabindex="-1"><a class="header-anchor" href="#构建特定阶段"><span>构建特定阶段</span></a></h4><p>使用 <code>--target</code> 参数可以指定构建到某个阶段：</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">只构建</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">builder</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">阶段</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">build</span><span class="space"> </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">--target</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">builder</span><span class="space"> </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">-t</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">username/imagename:tag</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="从其他镜像复制文件" tabindex="-1"><a class="header-anchor" href="#从其他镜像复制文件"><span>从其他镜像复制文件</span></a></h4><p>COPY 指令支持从其他阶段或外部镜像复制文件：</p><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">从上一阶段复制</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">COPY</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--from=builder</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/go/src/app</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">从指定镜像复制</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">COPY</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">--from=nginx:latest</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/etc/nginx/nginx.conf</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/nginx.conf</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-最佳实践" tabindex="-1"><a class="header-anchor" href="#_3-最佳实践"><span>3. 最佳实践</span></a></h2><ul><li>将构建阶段放在前面，运行阶段放在后面</li><li>使用 <code>as</code> 为每个阶段命名，提高可读性</li><li>只复制必要的文件，减少镜像体积</li><li>合理使用缓存，提高构建效率</li></ul>`,35))])}const A=e(d,[["render",g],["__file","index.html.vue"]]),u=JSON.parse('{"path":"/linux/xidpvb8z/","title":"08. Dockerfile多阶段创建","lang":"zh-CN","frontmatter":{"createTime":"2025/02/17 16:59:04","permalink":"/linux/xidpvb8z/","title":"08. Dockerfile多阶段创建","description":"简介 多阶段构建(Multi-stage builds)是 Docker 17.05 引入的新特性，它允许在一个 Dockerfile 中使用多个 FROM 语句。这种方式可以: 大幅减少最终镜像的体积 避免在构建过程中引入不必要的依赖 简化构建流程 1. 传统构建方式的问题 在多阶段构建出现之前，通常采用两种方式构建镜像： 全部放入一个 Docker...","head":[["meta",{"property":"og:url","content":"https://notes.moniter.top/linux/xidpvb8z/"}],["meta",{"property":"og:site_name","content":"Richie Lin"}],["meta",{"property":"og:title","content":"08. Dockerfile多阶段创建"}],["meta",{"property":"og:description","content":"简介 多阶段构建(Multi-stage builds)是 Docker 17.05 引入的新特性，它允许在一个 Dockerfile 中使用多个 FROM 语句。这种方式可以: 大幅减少最终镜像的体积 避免在构建过程中引入不必要的依赖 简化构建流程 1. 传统构建方式的问题 在多阶段构建出现之前，通常采用两种方式构建镜像： 全部放入一个 Docker..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"08. Dockerfile多阶段创建\\",\\"image\\":[\\"\\"],\\"dateModified\\":null,\\"author\\":[]}"]]},"headers":[],"git":{},"autoDesc":true,"filePathRelative":"notes/linux/Kubernetes/Docker系列学习/Docker系列学习-08.Dockerfile多阶段创建.md"}');export{A as comp,u as data};
